<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stripe Payment</title>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <div id="payment-element"></div>
  <button class="pay-now">PAY NOW</button>

  <script>
    // Define an object to hold the payment status and message
    window.StripePaymentStatus = {
      status: null,
      message: null
    };

    // Function to get query parameters from URL
    function getQueryParam(param) {
      let params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    // Get clientSecret from URL parameters
    const clientSecret = getQueryParam("client_secret");

    if (clientSecret) {
      const stripe = Stripe(
        "pk_test_51PgmWWJwumpIxqJ6XNpERy69SYGSo8f9q3RPtwQvSVFwMK2OmRQZ4qxysfr63Rr806dWdG6haWYsaToX7ozZR91n00KBw9jU6F"
      );

      const elements = stripe.elements({
        clientSecret: clientSecret,
      });

      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");

      document.querySelector(".pay-now").addEventListener("click", async () => {
        try {
          const { error, paymentIntent } = await stripe.confirmPayment({
            elements,
            confirmParams: {
              return_url: "", // No redirection
            },
            redirect: "if_required", // Avoid any redirection
          });

          if (error) {
            window.StripePaymentStatus.status = "failed";
            window.StripePaymentStatus.message = error.message;
            console.log("Payment failed:", error.message);
          } else {
            window.StripePaymentStatus.status = "success";
            window.StripePaymentStatus.message = "Payment is successfully done";
            console.log("Payment success:", JSON.stringify(window.StripePaymentStatus));
          }

          // Send the payment status to the parent window (Flutter app)
          window.parent.postMessage(JSON.stringify(window.StripePaymentStatus), "*");

        } catch (err) {
          window.StripePaymentStatus.status = "failed";
          window.StripePaymentStatus.message = err.message;
          console.log("Error during payment:", err.message);

          // Send the failure message to the parent window (Flutter app)
          window.parent.postMessage(JSON.stringify(window.StripePaymentStatus), "*");
        }
      });
    } else {
      console.error("No client_secret found in URL");
    }
  </script>
</body>
</html>
